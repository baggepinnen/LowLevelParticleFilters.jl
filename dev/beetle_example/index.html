<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Particle-filter tutorial · LowLevelParticleFilters Documentation</title><meta name="title" content="Particle-filter tutorial · LowLevelParticleFilters Documentation"/><meta property="og:title" content="Particle-filter tutorial · LowLevelParticleFilters Documentation"/><meta property="twitter:title" content="Particle-filter tutorial · LowLevelParticleFilters Documentation"/><meta name="description" content="Documentation for LowLevelParticleFilters Documentation."/><meta property="og:description" content="Documentation for LowLevelParticleFilters Documentation."/><meta property="twitter:description" content="Documentation for LowLevelParticleFilters Documentation."/><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../search_index.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../">LowLevelParticleFilters Documentation</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li><a class="tocitem" href="../discretization/">Discretization</a></li><li><a class="tocitem" href="../parameter_estimation/">Parameter estimation</a></li><li><a class="tocitem" href="../benchmark/">Benchmark</a></li><li><a class="tocitem" href="../distributions/">High-performance distributions</a></li><li><span class="tocitem">Tutorials</span><ul><li><a class="tocitem" href="../adaptive_kalmanfilter/">Kalman-filter tutorial with LowLevelParticleFilters</a></li><li><a class="tocitem" href="../noisetuning/">Noise tuning and disturbance modeling for Kalman filtering</a></li><li class="is-active"><a class="tocitem" href>Particle-filter tutorial</a><ul class="internal"><li><a class="tocitem" href="#Smoothing"><span>Smoothing</span></a></li><li><a class="tocitem" href="#Summary"><span>Summary</span></a></li></ul></li><li><a class="tocitem" href="../dae/">State estimation for DAE systems</a></li></ul></li><li><a class="tocitem" href="../api/">API</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Tutorials</a></li><li class="is-active"><a href>Particle-filter tutorial</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Particle-filter tutorial</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/baggepinnen/LowLevelParticleFilters.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/baggepinnen/LowLevelParticleFilters.jl/blob/master/docs/src/beetle_example.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Smoothing-the-track-of-a-moving-beetle"><a class="docs-heading-anchor" href="#Smoothing-the-track-of-a-moving-beetle">Smoothing the track of a moving beetle</a><a id="Smoothing-the-track-of-a-moving-beetle-1"></a><a class="docs-heading-anchor-permalink" href="#Smoothing-the-track-of-a-moving-beetle" title="Permalink"></a></h1><p>This is an example of smoothing the 2-dimensional trajectory of a moving dung beetle. The example spurred off of <a href="https://discourse.julialang.org/t/smoothing-tracks-with-a-kalman-filter/24209?u=yakir12">this Discourse topic</a>. For more information about the research behind this example, see <a href="https://www.lunduniversity.lu.se/article/artificial-light-disrupts-dung-beetles-sense-direction">Artificial light disrupts dung beetles’ sense of direction</a> and <a href="https://pubmed.ncbi.nlm.nih.gov/32902692/">A dung beetle that path integrates without the use of landmarks</a>. Special thanks to Yakir Gagnon for providing this example.</p><p>In this example we will describe the position coordinates, <span>$x$</span> and <span>$y$</span>, of the beetle as functions of its velocity, <span>$v_t$</span>, and direction, <span>$θ_t$</span>:</p><p class="math-container">\[\begin{aligned}
x_{t+1} &amp;= x_t + \cos(θ_t)v_t \\
y_{t+1} &amp;= y_t + \sin(θ_t)v_t \\
v_{t+1} &amp;= v_t + e_t \\
θ_{t+1} &amp;= θ_t + w_t
\end{aligned}\]</p><p>where <span>$e_t ∼ N(0,σ_e), w_t ∼ N(0,σ_w)$</span> The beetle further has two &quot;modes&quot;, one where it&#39;s moving towards a goal, and one where it&#39;s searching in a more erratic manner. Figuring out when this mode switch occurs is the goal of the filtering. The mode will be encoded as a state variable, and used to determine the amount of dynamic noise affecting the velocity of the beetle, i.e., in the searching mode, the beetle has more velocity noise. The mode switching is modeled as a stochastic process with a binomial distribution (coin flip) describing the likelihood of a switch from mode 0 (moving to goal) and mode 1 (searching). Once the beetle has started searching, it stays in that mode, i.e., the searching mode is &quot;sticky&quot; or &quot;terminal&quot;.</p><p>We load a single experiment from file for the purpose of this example (in practice, there may be hundreds of experiments)</p><pre><code class="language-julia hljs">using LowLevelParticleFilters, LinearAlgebra, StaticArrays, Distributions, Plots, Random
using DelimitedFiles
path = &quot;../track.csv&quot;
xyt = readdlm(path)
tosvec(y) = reinterpret(SVector{length(y[1]),Float64}, reduce(hcat,y))[:] |&gt; copy # helper function
y = tosvec(collect(eachrow(xyt[:,1:2])))</code></pre><p>We then define some properties of the dynamics and the filter. We will use an <a href="../#AdvancedParticleFilter"><code>AdvancedParticleFilter</code></a> since we want to have fine-grained control over the noise sampling for the mode switch.</p><pre><code class="language-julia hljs">N = 2000 # Number of particles in the particle filter
n = 4 # Dimension of state: we have speed and angle, so two
p = 2 # Dimension of measurements, we can measure the x and the y, so also two
@inline pos(s) = s[SVector(1,2)]
@inline vel(s) = s[3]
@inline ϕ(s) = s[4]
@inline mode(s) = s[5]</code></pre><p>We then define the probability distributions we need.</p><pre><code class="language-julia hljs">dgσ = 1 # the deviation of the measurement noise distribution
dvσ = 0.3 # the deviation of the dynamics noise distribution
ϕσ  = 0.5
const switch_prob = 0.03 # Probability of mode switch
const dg = MvNormal(@SVector(zeros(p)), dgσ^2) # Measurement noise Distribution
const df = LowLevelParticleFilters.TupleProduct((Normal.(0,[1e-1, 1e-1, dvσ, ϕσ])...,Binomial(1,switch_prob)))
const d0 = MvNormal(SVector(y[1]..., 0.5, atan((y[2]-y[1])...), 0), [3.,3,2,2,0])
const noisevec = zeros(5) # cache vector</code></pre><p>We now define the dynamics, since we use the advanced filter, we include the <code>noise=false</code> argument. The dynamics is directly defined in discrete time.</p><pre><code class="language-julia hljs">@inline function dynamics(s,u,p,t,noise=false)
    # current state
    m = mode(s)
    v = vel(s)
    a = ϕ(s)
    p = pos(s)
    # get noise
    if noise
        y_noise, x_noise, v_noise, ϕ_noise,_ = rand!(df, noisevec)
    else
        y_noise, x_noise, v_noise, ϕ_noise = 0.,0.,0.,0.
    end
    # next state
    v⁺ = max(0.999v + v_noise, 0.0)
    m⁺ = Float64(m == 0 ? rand() &lt; switch_prob : true)
    a⁺ = a + (ϕ_noise*(1 + m*10))/(1 + v⁺) # next state velocity is used here
    p⁺ = p + SVector(y_noise, x_noise) + SVector(sincos(a))*v⁺ # current angle but next velocity
    SVector{5,Float64}(p⁺[1], p⁺[2], v⁺, a⁺, m⁺) # all next state
end
function measurement_likelihood(s,u,y,p,t)
    logpdf(dg, pos(s)-y) # A simple linear measurement model with normal additive noise
end
@inline measurement(s,u,p,t,noise=false) = s[SVector(1,2)] + noise*rand(dg) # We observer the position coordinates with the measurement</code></pre><p>In this example, we have no control inputs, we thus define a vector of only zeros. We then solve the forward filtering problem and plot the results.</p><pre><code class="language-julia hljs">u = zeros(length(y))
pf = AuxiliaryParticleFilter(AdvancedParticleFilter(N, dynamics, measurement, measurement_likelihood, df, d0))
T = length(y)
sol = forward_trajectory(pf,u[1:T],y[1:T])
(; x,w,we,ll) = sol
plot(sol, markerstrokecolor=:auto, m=(2,0.5), format=:png)</code></pre><img src="3d0f43fe.svg" alt="Example block output"/><p>We can clearly see when the beetle switched mode (state variable 5). This corresponds well to annotations provided by a biologist and is the fundamental question we want to answer with the filtering procedure.</p><p>We can plot the mean of the filtered trajectory as well</p><pre><code class="language-julia hljs">xh = mean_trajectory(x,we)

&quot;plotting helper function&quot;
function to1series(x::AbstractVector, y)
    r,c = size(y)
    y2 = vec([y; fill(Inf, 1, c)])
    x2 = repeat([x; Inf], c)
    x2,y2
end
to1series(y) = to1series(1:size(y,1),y)

fig1 = plot(xh[:,1],xh[:,2], c=:blue, lab=&quot;estimate&quot;, legend=:bottomleft)
plot!(xyt[:,1],xyt[:,2], c=:red, lab=&quot;measurement&quot;)</code></pre><img src="41febccb.svg" alt="Example block output"/><p>as well as the angle state variable (we subsample the particles to not get sluggish plots)</p><pre><code class="language-julia hljs">fig2 = scatter(to1series(ϕ.(x)&#39;[:,1:5:end])..., m=(:black, 0.03, 2), lab=&quot;&quot;, size=(500,300), format=:png)
plot!(identity.(xh[:,4]), lab=&quot;Filtered angle&quot;, legend=:topleft, ylims=(-30, 70), format=:png)</code></pre><img src="d50760c9.svg" alt="Example block output"/><p>The particle plot above indicate that the posterior is multimodal. This phenomenon arises due to the simple model that uses an angle that is allowed to leave the interval `<code>0-2\pi</code> rad. In this example, we are not interested in the angle, but rather when the beetle switches mode. The filtering distribution above gives a hint at when this happens, but we will not plot the mode trajectory until we have explored smoothing as well.</p><h2 id="Smoothing"><a class="docs-heading-anchor" href="#Smoothing">Smoothing</a><a id="Smoothing-1"></a><a class="docs-heading-anchor-permalink" href="#Smoothing" title="Permalink"></a></h2><p>The filtering results above does not use all the available information when trying to figure out the state trajectory. To do this, we may call a smoother. We use a particle smoother and compute 10 smoothing trajectories.</p><pre><code class="language-julia hljs">M = 10 # Number of smoothing trajectories, NOTE: if this is set higher, the result will be better at the expense of linear scaling of the computational cost.
sb,ll = smooth(pf, M, u, y) # Sample smooting particles (b for backward-trajectory)
sbm = smoothed_mean(sb)     # Calculate the mean of smoothing trajectories
sbt = smoothed_trajs(sb)    # Get smoothing trajectories
plot!(fig1, sbm[1,:],sbm[2,:], lab=&quot;xs&quot;)</code></pre><img src="7afb6df4.svg" alt="Example block output"/><pre><code class="language-julia hljs">plot!(fig2, identity.(sbm&#39;[:,4]), lab=&quot;smoothed&quot;, format=:png)</code></pre><img src="e82c8201.svg" alt="Example block output"/><p>We see that the smoothed trajectory may look very different from the filter trajectory. This is an indication that it&#39;s hard to tell what state the beetle is currently in, but easier to look back and tell what state the beetle must have been in at a historical point. </p><p>We can also visualize the mode state</p><pre><code class="language-julia hljs">plot(xh[:,5], lab=&quot;Filtering&quot;)
plot!(to1series(sbt[5,:,:]&#39;)..., lab=&quot;Smoothing&quot;, title=&quot;Mode trajectories&quot;, l=(:black,0.2))</code></pre><img src="c5788d32.svg" alt="Example block output"/><p>also this state variable indicates that it&#39;s hard to tell what state the beetle is in during filtering, but obvious with hindsight (smoothing). The mode switch occurs when the filtering distribution of the angle becomes drastically wider, indicating that increased dynamics noise is required in order to describe the motion of the beetle.</p><h2 id="Summary"><a class="docs-heading-anchor" href="#Summary">Summary</a><a id="Summary-1"></a><a class="docs-heading-anchor-permalink" href="#Summary" title="Permalink"></a></h2><p>This example has demonstrated filtering and smoothing in an advanced application that includes manual control over noise, mixed continuous and discrete state.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../noisetuning/">« Noise tuning and disturbance modeling for Kalman filtering</a><a class="docs-footer-nextpage" href="../dae/">State estimation for DAE systems »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.7.0 on <span class="colophon-date" title="Monday 4 November 2024 09:54">Monday 4 November 2024</span>. Using Julia version 1.11.1.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
